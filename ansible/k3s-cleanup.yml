---
- name: Clean up disk usage on k3s worker nodes
  hosts: k3s_workers
  gather_facts: false
  become: true
  vars:
    root_fs_usage_threshold: 75
    containerd_usage_threshold_mb: 4096
    run_prune_when_high: true
    force_cleanup: false
    journal_vacuum_window: 7d
  tasks:
    - name: Gather current disk usage details
      import_tasks: tasks/k3s_disk_report.yml

    - name: Decide if cleanup should execute
      set_fact:
        cleanup_should_run: {{ force_cleanup | bool or cleanup_recommended | default(false) | bool }}

    - name: Cleanup not required message
      when: not cleanup_should_run
      debug:
        msg:
          - "Cleanup not required on {{ inventory_hostname }}."
          - "cleanup_recommended={{ cleanup_recommended | default(false) }}"
          - "force_cleanup={{ force_cleanup }}"

    - name: Perform cleanup workflow
      when: cleanup_should_run
      block:
        - name: Prune unused container images
          command: k3s crictl rmi --prune
          register: prune_result

        - name: Show prune output
          debug:
            msg:
              - "Prune command rc={{ prune_result.rc }}"
              - "stdout: {{ prune_result.stdout | default('') }}"
              - "stderr: {{ prune_result.stderr | default('') }}"

        - name: Vacuum old journals
          command: journalctl --vacuum-time={{ journal_vacuum_window }}
          register: journal_vacuum

        - name: Show journal vacuum result
          debug:
            msg:
              - "Journal vacuum rc={{ journal_vacuum.rc }}"
              - "stdout: {{ journal_vacuum.stdout | default('') }}"
              - "stderr: {{ journal_vacuum.stderr | default('') }}"

        - name: Capture containerd usage after cleanup (MB)
          command: du -sm /var/lib/rancher/k3s/agent/containerd
          register: containerd_usage_after
          failed_when: containerd_usage_after.rc not in [0, 1]
          changed_when: false

        - name: Capture root filesystem usage after cleanup
          command: df --output=pcent --target /
          register: root_df_after
          changed_when: false

        - name: Report post-cleanup usage
          debug:
            msg:
              - "containerd usage before cleanup: {{ containerd_usage_mb }} MB"
              - "containerd usage after cleanup: {{ (containerd_usage_after.stdout | regex_search('\\d+')) | default(0, true) | int }} MB"
              - "Root usage before cleanup: {{ root_usage_percent }}%"
              - "Root usage after cleanup: {{ (root_df_after.stdout_lines | last | regex_search('\\d+')) | int }}%"

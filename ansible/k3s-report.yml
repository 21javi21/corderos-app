---
- name: Report disk usage on k3s worker nodes
  hosts: k3s_nodes
  gather_facts: false
  become: true
  vars:
    root_fs_usage_threshold: 75          # % máximo permitido en raíz
    containerd_usage_threshold_mb: 4096  # MB máximo en containerd
    run_prune_when_high: true            # Ejecutar prune si se supera el umbral
  tasks:
    - name: Collect disk usage details
      import_tasks: tasks/k3s_disk_report.yml

    - name: Trigger prune if root usage is high
      debug:
        msg: "Root FS usage exceeded threshold ({{ root_usage_percent }}%), prune may be required."
      when: root_usage_high | bool
      notify: docker_system_prune

    - name: Trigger prune if containerd usage is high
      debug:
        msg: "Containerd usage exceeded threshold ({{ containerd_usage_mb }} MB), prune may be required."
      when: containerd_usage_high | bool
      notify: docker_system_prune

  handlers:
    - name: docker_system_prune
      block:
        - name: Run docker system prune (aggressive)
          command: docker system prune -af --volumes
          when: run_prune_when_high | bool
        - name: Show free space after prune
          command: df -h /
          register: after_prune
        - name: Debug free space after prune
          debug:
            var: after_prune.stdout_lines

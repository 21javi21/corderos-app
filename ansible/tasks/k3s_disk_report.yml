---
- name: Check root filesystem usage
  command: df --output=pcent /
  register: root_df
  changed_when: false

- name: Extract root filesystem usage percentage
  set_fact:
    root_usage_percent: "{{ (root_df.stdout_lines | last | regex_search('\\d+')) | int }}"

- name: Flag root usage above threshold
  set_fact:
    root_usage_high: "{{ (root_usage_percent | int) >= (root_fs_usage_threshold | int) }}"

- name: Debug root filesystem usage
  debug:
    msg: "Root FS usage: {{ root_usage_percent }}% (Threshold: {{ root_fs_usage_threshold }}%)"

- name: Check containerd data directory size
  command: du -sm /var/lib/containerd
  register: containerd_du
  changed_when: false
  failed_when: false

- name: Extract containerd usage MB
  set_fact:
    containerd_usage_mb: "{{ (containerd_du.stdout | regex_search('\\d+')) | int if containerd_du.stdout is defined else 0 }}"

- name: Flag containerd usage above threshold
  set_fact:
    containerd_usage_high: "{{ (containerd_usage_mb | int) >= (containerd_usage_threshold_mb | int) }}"

- name: Debug containerd usage
  debug:
    msg: "Containerd usage: {{ containerd_usage_mb }} MB (Threshold: {{ containerd_usage_threshold_mb }} MB)"
